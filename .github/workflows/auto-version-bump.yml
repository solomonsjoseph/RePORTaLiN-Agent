# =============================================================================
# Automatic Semantic Versioning with Commitizen
# =============================================================================
# This workflow automatically bumps the version based on conventional commits
# when changes are pushed/merged to the main branch.
#
# How it works:
#   1. Triggers on push to main branch
#   2. Analyzes commit messages since last tag
#   3. Bumps version based on commit types:
#      - fix:  → PATCH (0.0.x)
#      - feat: → MINOR (0.x.0)
#      - feat!/BREAKING CHANGE: → MAJOR (x.0.0)
#   4. Updates __version__.py, pyproject.toml, CHANGELOG.md
#   5. Creates git tag and pushes changes
#
# Manual trigger: Actions → Auto Version Bump → Run workflow
# =============================================================================

name: Auto Version Bump

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # Allow manual trigger

jobs:
  bump-version:
    name: Bump Version
    runs-on: ubuntu-latest
    # Don't run on bump commits (prevents infinite loop)
    if: ${{ !startsWith(github.event.head_commit.message, 'bump:') }}

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for commitizen
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install commitizen
        run: pip install commitizen

      - name: Configure git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Bump version
        id: bump
        run: |
          # Check if there are commits to bump
          if cz bump --dry-run 2>&1 | grep -q "NO_COMMITS_TO_BUMP"; then
            echo "No version bump needed"
            echo "bumped=false" >> $GITHUB_OUTPUT
          else
            # Perform the actual bump
            cz bump --yes --changelog
            echo "bumped=true" >> $GITHUB_OUTPUT
            # Get new version
            NEW_VERSION=$(grep "^__version__" __version__.py | sed 's/.*"\(.*\)"/\1/')
            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Push changes
        if: steps.bump.outputs.bumped == 'true'
        run: |
          git push
          git push --tags

      - name: Summary
        if: steps.bump.outputs.bumped == 'true'
        run: |
          echo "## ✅ Version Bumped!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**New Version:** v${{ steps.bump.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Changes pushed to \`${{ github.ref_name }}\` branch with tag \`v${{ steps.bump.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
