# =============================================================================
# RePORTaLiN Specialist MCP Server - Security-Hardened Production Dockerfile
# =============================================================================
# Multi-stage build for optimized, SECURE, minimal image
#
# SECURITY FEATURES:
#   ✓ Non-root user execution (UID 10001, Kubernetes-friendly)
#   ✓ Read-only root filesystem compatible
#   ✓ No new privileges (seccomp compatible)
#   ✓ Minimal attack surface (slim base + aggressive cleanup)
#   ✓ tini init for proper signal handling and zombie reaping
#   ✓ Health checks without network dependency
#   ✓ PHI/PII never exposed - only aggregates/schemas
#
# NETWORK ISOLATION:
#   - Container runs in isolated network (--network=none)
#   - Only stdin/stdout communication (stdio transport)
#   - No outbound internet access
#
# FILE SYSTEM:
#   - Data mounted as read-only (:ro)
#   - Only encrypted_logs directory is writable
#   - tmpfs for /tmp with noexec
#
# Transports:
#   - stdio (RECOMMENDED): For Claude Desktop - maximum isolation
#   - streamable-http: For local web apps only (not recommended for PHI)
#
# Build with BuildKit:
#   DOCKER_BUILDKIT=1 docker build -f Dockerfile.secure -t reportalin-secure .
#
# Run with maximum security:
#   docker run -i --rm --network none \
#     --read-only --tmpfs /tmp:noexec,nosuid,size=64m \
#     --security-opt=no-new-privileges:true \
#     --cap-drop=ALL \
#     -v $(pwd)/results/data_dictionary_mappings:/app/results:ro \
#     reportalin-secure

# -----------------------------------------------------------------------------
# Stage 1: Build dependencies with uv (fast, reproducible)
# -----------------------------------------------------------------------------
FROM python:3.13-slim-bookworm AS builder

# Security: Don't store pip cache, disable version check
ENV PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PYTHONDONTWRITEBYTECODE=1

WORKDIR /build

# Install uv - fast Python package installer
RUN pip install --no-cache-dir uv

# Copy dependency files (pyproject.toml is the single source of truth)
COPY pyproject.toml .python-version ./

# Create virtual environment and install dependencies with uv
# --frozen ensures lockfile is used if present (uv.lock)
RUN uv venv /opt/venv && \
    . /opt/venv/bin/activate && \
    uv sync --frozen --no-dev 2>/dev/null || uv sync --no-dev

# Aggressive cleanup to minimize attack surface
RUN find /opt/venv -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true && \
    find /opt/venv -type f -name "*.pyc" -delete 2>/dev/null || true && \
    find /opt/venv -type f -name "*.pyo" -delete 2>/dev/null || true && \
    find /opt/venv -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true && \
    find /opt/venv -type d -name "test" -exec rm -rf {} + 2>/dev/null || true && \
    find /opt/venv -type d -name "docs" -exec rm -rf {} + 2>/dev/null || true && \
    find /opt/venv -type d -name "examples" -exec rm -rf {} + 2>/dev/null || true && \
    rm -rf /opt/venv/share/doc /opt/venv/share/man /opt/venv/share/info

# -----------------------------------------------------------------------------
# Stage 2: Production image (Security Hardened)
# -----------------------------------------------------------------------------
FROM python:3.13-slim-bookworm AS production

# Security labels (OCI standard)
LABEL org.opencontainers.image.title="RePORTaLiN Specialist MCP Server (Secure)" \
      org.opencontainers.image.description="Security-hardened MCP Server for RePORT India - PHI Protected" \
      org.opencontainers.image.vendor="RePORTaLiN Team" \
      org.opencontainers.image.licenses="MIT" \
      security.policy="no-new-privileges,read-only-rootfs,cap-drop-all" \
      data.classification="PHI/PII-Protected"

# Install tini for proper init (minimal addition)
RUN apt-get update && \
    apt-get install -y --no-install-recommends tini && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* && \
    rm -rf /var/log/* /var/cache/*

# Security: Create non-root user with high UID (>10000 for Kubernetes)
RUN groupadd --gid 10001 mcp && \
    useradd --uid 10001 --gid mcp --shell /usr/sbin/nologin --create-home --home-dir /app mcp

WORKDIR /app

# Copy virtual environment from builder
COPY --from=builder --chown=mcp:mcp /opt/venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Copy only necessary application files (minimal footprint)
COPY --chown=mcp:mcp server/ ./server/
COPY --chown=mcp:mcp client/ ./client/
COPY --chown=mcp:mcp shared/ ./shared/
COPY --chown=mcp:mcp scripts/utils/ ./scripts/utils/
COPY --chown=mcp:mcp scripts/core/ ./scripts/core/
COPY --chown=mcp:mcp scripts/__init__.py ./scripts/

COPY --chown=mcp:mcp config.py .
COPY --chown=mcp:mcp __version__.py .

# Create directories for runtime
RUN mkdir -p /app/results /app/encrypted_logs && \
    chown -R mcp:mcp /app && \
    chmod 700 /app/encrypted_logs

# Security: Set restrictive permissions
RUN chmod -R 500 /app/server /app/client /app/shared /app/scripts && \
    chmod 400 /app/config.py /app/__version__.py

# Security: Switch to non-root user
USER mcp

# Environment variables for secure configuration
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONHASHSEED=random \
    PYTHONPYCACHEPREFIX=/tmp/.pycache \
    MCP_TRANSPORT=stdio \
    MCP_HOST=127.0.0.1 \
    MCP_PORT=8000 \
    # Privacy: Strict mode enforced
    REPORTALIN_PRIVACY_MODE=strict \
    # Security: Disable debug
    PYTHONFAULTHANDLER=0

# Expose port for HTTP transport (only if needed for local web apps)
EXPOSE 8000

# Health check that doesn't require network
HEALTHCHECK --interval=60s --timeout=5s --start-period=10s --retries=2 \
    CMD ["python", "-c", "import sys; sys.exit(0)"]

# Use tini as init for proper signal handling
ENTRYPOINT ["/usr/bin/tini", "--", "python", "-m", "server"]

# Default: stdio transport (maximum security)
CMD ["--transport", "stdio"]
