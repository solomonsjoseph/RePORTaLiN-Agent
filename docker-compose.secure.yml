# =============================================================================
# RePORTaLiN Specialist MCP Server - Secure Docker Compose
# =============================================================================
# Production deployment configuration with maximum security isolation
#
# SECURITY FEATURES:
#   ✓ Network isolation (no internet access)
#   ✓ Read-only file system
#   ✓ Read-only data mounts
#   ✓ No privileged access
#   ✓ Resource limits (prevent DoS)
#   ✓ Capability dropping
#   ✓ Seccomp/AppArmor profiles
#
# USAGE:
#   # Build the secure image
#   docker-compose -f docker-compose.secure.yml build
#
#   # Run with stdio transport (for Claude Desktop)
#   docker-compose -f docker-compose.secure.yml run --rm mcp-stdio
#
#   # Run with HTTP transport (local only, not recommended for PHI)
#   docker-compose -f docker-compose.secure.yml up mcp-http
#
# =============================================================================

version: "3.9"

# Isolated network with no external access
networks:
  mcp-isolated:
    driver: bridge
    internal: true  # No internet access
    driver_opts:
      com.docker.network.bridge.enable_ip_masquerade: "false"

services:
  # ==========================================================================
  # MCP Server - stdio transport (RECOMMENDED for Claude Desktop)
  # ==========================================================================
  mcp-stdio:
    build:
      context: .
      dockerfile: Dockerfile.secure
      target: production
    image: reportalin-specialist:secure
    container_name: reportalin-mcp-stdio

    # SECURITY: Run with minimal privileges
    user: "10001:10001"
    read_only: true
    
    # SECURITY: Network isolation - no network access at all
    network_mode: none
    
    # SECURITY: Drop all capabilities
    cap_drop:
      - ALL
    
    # SECURITY: Prevent privilege escalation
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined  # Use default seccomp if available

    # SECURITY: Resource limits
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M

    # VOLUMES: Read-only data, only logs are writable
    volumes:
      # Data dictionary - READ ONLY
      - type: bind
        source: ./data/data_dictionary_and_mapping_specifications
        target: /app/data/data_dictionary
        read_only: true
      
      # Encrypted logs - writable (only writable mount)
      - type: bind
        source: ./encrypted_logs
        target: /app/encrypted_logs
        read_only: false
      
      # Temporary filesystem - noexec for security
      - type: tmpfs
        target: /tmp
        tmpfs:
          size: 100M
          mode: 1777

    # Environment for privacy mode
    environment:
      - REPORTALIN_PRIVACY_MODE=strict
      - MCP_TRANSPORT=stdio
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1

    # stdin/stdout for MCP stdio transport
    stdin_open: true
    tty: false

    # Override to ensure stdio transport
    command: ["--transport", "stdio"]

    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 60s
      timeout: 5s
      retries: 2
      start_period: 10s

  # ==========================================================================
  # MCP Server - HTTP transport (LOCAL USE ONLY)
  # ==========================================================================
  mcp-http:
    build:
      context: .
      dockerfile: Dockerfile.secure
      target: production
    image: reportalin-specialist:secure
    container_name: reportalin-mcp-http

    # SECURITY: Run with minimal privileges
    user: "10001:10001"
    read_only: true

    # SECURITY: Isolated network (internal only)
    networks:
      - mcp-isolated

    # SECURITY: Only localhost binding
    ports:
      - "127.0.0.1:8000:8000"  # Bind to localhost only

    # SECURITY: Drop all capabilities
    cap_drop:
      - ALL
    
    # SECURITY: Prevent privilege escalation
    security_opt:
      - no-new-privileges:true

    # SECURITY: Resource limits
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M

    # VOLUMES: Read-only data, only logs are writable
    volumes:
      # Data dictionary - READ ONLY
      - type: bind
        source: ./data/data_dictionary_and_mapping_specifications
        target: /app/data/data_dictionary
        read_only: true
      
      # Encrypted logs - writable
      - type: bind
        source: ./encrypted_logs
        target: /app/encrypted_logs
        read_only: false
      
      # Temporary filesystem
      - type: tmpfs
        target: /tmp
        tmpfs:
          size: 100M
          mode: 1777

    # Environment
    environment:
      - REPORTALIN_PRIVACY_MODE=strict
      - MCP_TRANSPORT=http
      - MCP_HOST=0.0.0.0
      - MCP_PORT=8000
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1

    # HTTP transport command
    command: ["--http", "--host", "0.0.0.0", "--port", "8000"]

    # Health check for HTTP
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
